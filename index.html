<html>
  <head>
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
    <meta name="description" content="A storage of my made musics.">
    <script>
      var list = [];
      var sounds = []; // sounds
      var curSndId = [0, 0];
      window.onload = function() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4) {
            if (this.status == 200) {
              
              // get list
              var tmp = this.responseText;
              var lines = tmp.split("\n");
              for (var i = 0; i < lines.length; i++) {
                if (lines[i].indexOf("## ") == 0) {
                  list.push([lines[i].substring(3)]);
                } else if (lines[i].indexOf(".mp3") > 0) {
                  list[list.length - 1].push(lines[i].substring(lines[i].indexOf(".mp3") + 6, lines[i].length - 1)) 
                }
              }
              
              console.log(tmp);
              console.log(lines);
              console.log(list);
              
              showList();
              loadSound();
              
            } else {
              alert("failed to load data");
            }
          }
        }
        //xhttp.open("GET", "/contents/AppList.json", true);
        xhttp.open("GET", "/MusicCloud/README.md", true);
        xhttp.send();
      }
      
      function showList() {
        var board = document.getElementById("board");
        var strHtml = "<ul>";
        for (var i = 0; i < list.length; i++) {
          strHtml += "<li>" + list[i][0] + "<ul>";
          for (var j = 1; j < list[i].length; j++) {
            strHtml += "<li>" + list[i][j] + "</li>";
          }
          strHtml += "</ul></li>";
        }
        strHtml += "</ul>";
        board.innerHTML = strHtml;
      }
      
      function loadSound() {
        for (var i = 0; i < list.length; i++) {
          sounds.push([]);
          for (var j = 1; j < list[i].length; j++) {
            sounds[i].push(new Audio(list[i][j]));
            sounds[i][j - 1].volumn = 0.3;
            sounds[i][j - 1].onended = function() {
              if (++curSndId[1] >= sounds[curSndId[0]].length) {
                curSndId[1] = 0;
                curSndId[0]++;
                if (curSndId[0] >= sounds.length) {
                  curSndId[0] = 0;
                }
              }
              
              sounds[curSndId[0]][curSndId[1]].currentTime = 0;
              sounds[curSndId[0]][curSndId[1]].play();
            }
          }
        }
      }
      
      function startPlay() {
        sounds[0][0].play();
      }
      
      function startPlay2() {
        var player = document.getElementById("player");
        player.src = list[curSndId[0]][curSndId[0]+1];
        player.load();
        player.play();
      }
      
      function playNext() {
        if (++curSndId[1] >= (list[curSndId[0]].length) - 1) {
          curSndId[1] = 0;
          curSndId[0]++;
          if (curSndId[0] >= list.length) {
            curSndId[0] = 0;
          }
        }
        
        console.log(curSndId);
        startPlay2();
      }
    </script>
  </head>
  <body>
    <div id="board"></div>
    <div>
       <audio id="player" controls onended="playNext()" />
    </div>
    <button onclick="startPlay()">Start Play</button>
    <button onclick="startPlay2()">Start Play2</button>
  </body>
</html>
